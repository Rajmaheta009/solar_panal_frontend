<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Dashboard - SB Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
    <link href="css/styles.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
</head>

<body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
        <a class="navbar-brand ps-3" href="index.html">Welcome Admin</a>
        <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
        <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
            <div class="input-group">
                <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />
                <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="fas fa-search"></i></button>
            </div>
        </form>
        <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                    <li><a class="dropdown-item" href="../login_registration/index.html" onclick="logoutAdmin()">Logout</a></li>
                </ul>
            </li>
        </ul>
    </nav>
    <div id="layoutSidenav">
        <div id="layoutSidenav_nav">
            <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                <div class="sb-sidenav-menu">
                    <div class="nav">
                        <div class="sb-sidenav-menu-heading">Core</div>
                        <a class="nav-link" href="index.html">
                            <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                            Dashboard
                        </a>
                        <a class="nav-link" href="user.html">
                            <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                            user
                        </a>
                        <a class="nav-link" href="product.html">
                            <div class="sb-nav-link-icon"><i class="fas fa-book-open"></i></div>
                            product
                        </a>
                    </div>
                </div>
                <div class="sb-sidenav-footer">
                    <div class="small">Logged in as:</div>
                    Admin Only
                </div>
            </nav>
        </div>
        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4">
                    <h1 class="mt-4">User</h1>
                    <button class="btn btn-success" id="addUserBtn" data-bs-toggle="modal" data-bs-target="#userModal" style="right: 24px; position: absolute;">
                        + Add User
                    </button>

                    <ol class="breadcrumb mb-4">
                        <li class="breadcrumb-item active">user</li>
                    </ol>
                    <table class="table table-dark table-striped" id="userTable">
                        <thead>
                            <tr>
                                <th>id</th>
                                <th>name</th>
                                <th>email</th>
                                <th>phone number</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </main>
            <footer class="py-4 bg-light mt-auto">
                <div class="container-fluid px-4">
                    <div class="d-flex align-items-center justify-content-between small">
                        <div class="text-muted">Copyright &copy; SOLAR PANAL 2025</div>
                        <div>
                            <a href="#">Privacy Policy</a> &middot;
                            <a href="#">Terms & Conditions</a>
                        </div>
                    </div>
                </div>
            </footer>
            <div class="container mt-4">
                <!-- User Modal -->
                <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalTitle">Add User</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="&times"></button>
                            </div>
                            <div class="modal-body">
                                <form id="userForm">
                                    <input type="hidden" id="userId">

                                    <div class="mb-3">
                                        <label for="username" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="username" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" required>
                                    </div>
                                    <div class="mb-3" id="passwordField">
                                        <label for="password" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="password">
                                    </div>
                                    <div class="mb-3">
                                        <label for="phonenumber" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phonenumber" pattern="[0-9]{10}" maxlength="10" minlength="10" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="userRole" class="form-label">Role</label>
                                        <select id="userRole" class="form-select" required>
                                            <option value="admin">Admin</option>
                                            <option value="user">User</option>
                                        </select>
                                    </div>
                                    <!-- Move Save button outside the select field -->
                                    <div class="mb-3">
                                        <button type="submit" class="btn btn-success">Save</button>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="js/scripts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
<script src="js/datatables-simple-demo.js"></script>
<script>
    async function fetchUsers() {
        try {
            const response = await fetch("http://127.0.0.1:8000/auth/users");
            if (!response.ok);

            const users = await response.json();
            console.log(users);

            const tableBody = document.querySelector("#userTable tbody");
            tableBody.innerHTML = "";

            if (!users.length) {
                tableBody.innerHTML = "<tr><td colspan='6' class='text-center'>No users found</td></tr>";
                return;
            }

            let count = 0;
            users.forEach(user => {
                count++;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${count}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phonenumber}</td>
                    <td>${user.role}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editUser('${user.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error("Error fetching users:", error);
        }
    }


    async function addOrUpdateUser(event) {
        event.preventDefault(); // Prevent form submission reload

        const userId = document.getElementById("userId").value.trim();
        const name = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const phonenumber = document.getElementById("phonenumber").value.trim();
        const role = document.getElementById("userRole").value.trim();

        const userData = {
            name,
            email,
            phonenumber,
            role,
            password: password || undefined, // Default password
            is_delete: false
        };

        let url = "http://127.0.0.1:8000/auth/register"; // Default to create
        let method = "POST"; // Default to create

        if (userId) {
            // If userId exists, it's an update request
            url = `http://127.0.0.1:8000/auth/users/${userId}`;
            method = "PUT";
            delete userData.password; // Remove password from update request
        } else {
            const password = document.getElementById("password").value.trim();
            if (!password) {
                alert("Password is required for new users!");
                return;
            }
            userData.password = password;
        }
        const a_token = localStorage.getItem("authToken"); // This will print the stored token in the console
        const u_name = localStorage.getItem("username");

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${a_token}`, // Include token
                    "User-Name": u_name
                },
                body: JSON.stringify(userData),
            });

            if (!response.ok) throw new Error("Failed to save user");

            // Close the modal
            const userModal = bootstrap.Modal.getInstance(document.getElementById("userModal"));
            userModal.hide();

            // Refresh the user list
            fetchUsers();

        } catch (error) {
            console.error("Error saving user:", error);
        }
    }

    // Attach function to form
    document.getElementById("userForm").addEventListener("submit", addOrUpdateUser);

    async function editUser(userId) {
        const token = localStorage.getItem("token"); // Get token from localStorage

        if (!token) {
            alert("You are not authorized. Please log in.");
            return;
        }

        try {
            const response = await fetch(`http://127.0.0.1:8000/auth/users/${userId}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`, // Include token
                },
            });
            if (!response.ok) throw new Error("Failed to fetch user data");
            const user = await response.json();

            document.getElementById("userId").value = user.id;
            document.getElementById("username").value = user.name;
            document.getElementById("email").value = user.email;
            document.getElementById("passwordField").value = user.password;
            document.getElementById("phonenumber").value = user.phonenumber;
            document.getElementById("userRole").value = user.role;

            document.getElementById("passwordField").style.display = "none";
            document.getElementById("modalTitle").innerText = "Edit User";

            const userModal = new bootstrap.Modal(document.getElementById("userModal"));
            userModal.show();

        } catch (error) {
            console.error("Error fetching user data:", error);
        }
    }

    async function deleteUser(id) {
        if (!confirm("Are you sure you want to delete this user?")) return;
        const a_token = localStorage.getItem("authToken");
        try {
            const response = await fetch(`http://127.0.0.1:8000/auth/users/${id}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${a_token}`, // Include token
                    "User-Name": localStorage.getItem("username")
                },
            });
            if (response.ok) {
                fetchUsers();
                location.reload();
            } else {
                alert("Failed to delete user");
            }
        } catch (error) {
            alert("Network error");
        }
    }

    // Reset form when clicking "Add User" button
    document.getElementById("addUserBtn").addEventListener("click", function() {
        document.getElementById("modalTitle").innerText = "Add User"; // Update modal title
        document.getElementById("userForm").reset(); // Clear form fields
        document.getElementById("userId").value = ""; // Clear hidden userId field
        document.getElementById("passwordField").style.display = "block"; // Show password field
    });

    // Handle form submission
    document.getElementById("userForm").addEventListener("submit", function(e) {
        e.preventDefault();
        addOrUpdateUser();
    });

    // Fetch users on page load
    document.addEventListener("DOMContentLoaded", fetchUsers);

    function logoutAdmin() {
        localStorage.removeItem("adminToken"); // Remove token
        window.location.href = "../login_registration/index.html"; // Redirect to login
    }
    document.getElementById('btnNavbarSearch').addEventListener('click', function() {
        let searchQuery = document.querySelector('.form-control').value.toLowerCase();
        if (searchQuery.trim() === "") {
            alert("Please enter a search term");
            return;
        }

        // Example: Redirect to a search results page
        window.location.href = `search_results.php?query=${encodeURIComponent(searchQuery)}`;
    });

    document.querySelector('.form-control').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            document.getElementById('btnNavbarSearch').click();
        }
    });
</script>

</html>